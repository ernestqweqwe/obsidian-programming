# Critical Rendering Path

**Critical Rendering Path** — это последовательность шагов, через которые браузер проходит, чтобы отобразить содержимое страницы на экране. Включает в себя анализ HTML/CSS, построение внутренних структур и их отрисовку.

---

## 1. Получение и парсинг HTML

- Браузер начинает загружать HTML с сервера.
- HTML читается **инкрементально**, по мере поступления данных.
- HTML разбивается на токены (теги, текст, комментарии).
- Из токенов создаются узлы, и строится **DOM-дерево**.

> DOM (Document Object Model) — иерархическое представление HTML-документа в виде объектов.

---

## 2. Загрузка и парсинг CSS

- При встрече с тегом `<link rel="stylesheet">` парсинг HTML продолжается, **но рендеринг блокируется**, пока CSS не загружен и не распарсен.
- CSS-файл парсится полностью, создаётся **CSSOM (CSS Object Model)**.
- CSSOM нельзя построить по частям из-за зависимости стилей (наследование, каскад и т.д.).

> Медиа-запросы (например, `media="print"`) **не блокируют рендеринг**, пока условие не выполнено.

---

## 3. Построение Render Tree

Render Tree = DOM + CSSOM → включает только **видимые** элементы.

### 3.1 Фильтрация DOM-элементов

**Исключаются:**
- `display: none`
- невизуальные теги (`<meta>`, `<script>`, комментарии)
- пустые текстовые узлы

**Остаются:**
- `visibility: hidden` — участвуют в layout, но не видимы
- `opacity: 0` — участвуют в layout и paint, но полностью прозрачны

### 3.2 Применение CSSOM к DOM

- Подбор CSS-правил по селекторам
- Применяется **каскад (cascade)**:
  - специфичность
  - порядок
  - наследование
  - `!important`
- Вычисляются **computed styles**

### 3.3 Создание Render Objects

Render Object = визуальный объект (не DOM-узел), описывающий, как должен быть отрисован элемент.

**Render Object содержит:**
- Тип: block, inline, flex, grid и т.д.
- Вычисленные стили: цвета, шрифты, размеры, отступы
- Содержимое: текст, дочерние render objects, псевдоэлементы

### 3.4 Особые случаи

- **Анонимные контейнеры** — создаются для согласования inline/block элементов
- **Псевдоэлементы `::before` и `::after`** — отдельные render objects, если задан `content`
- **Текстовые узлы** — каждый кусок текста = отдельный render object

---

## 4. Layout (Reflow)

**Layout** — определение точного размера и позиции каждого render object.

- Начинается с корня Render Tree, рекурсивно вниз
- Вычисляется:
  - ширина и высота
  - координаты x/y
  - отступы, границы, паддинги (блочная модель)

> Layout — один из самых затратных этапов. Любое изменение, влияющее на геометрию, может вызвать **reflow**.

---

## 5. Paint

**Paint** — отрисовка элементов на экране. Render Tree превращается в пиксели.

- Визуализируются:
  - фон
  - текст
  - изображения
  - тени
  - границы
  - трансформации и т.д.

> Браузер создаёт **растровое представление слоёв**, но пока они не показаны пользователю.

---

## 6. Composite (Составление)

**Composite** — финальный этап, где слои, отрисованные на этапе Paint, объединяются в финальную картину:

- Учитываются:
  - `z-index`
  - `opacity`
  - трансформации (`transform`)
  - наложения слоёв (compositing layers)

> Браузер использует GPU для быстрого склеивания слоёв (особенно при `will-change`, `position: fixed`, `transform`, `opacity`).

Вот какие изменения могут вызвать повторные шаги Critical Rendering Path:

---

## Изменения, вызывающие `reflow` (layout):

- Изменения геометрии:
    
    - `width`, `height`
        
    - `margin`, `padding`, `border`
        
    - `position`, `top`, `left`, `right`, `bottom`
        
- Изменения DOM-структуры:
    
    - добавление/удаление элементов
        
    - изменение количества текста
        
- Изменение шрифтов
    
- Программное чтение layout-свойств (`offsetHeight`, `clientWidth` и т.д.) → вызывает _forced reflow_
    

**→ Запускает: layout → paint → composite**

---

## Изменения, вызывающие `repaint` (без layout):

- `color`, `background`, `box-shadow`
    
- `visibility`, `outline`
    
- `opacity: 0.9 → 0.8` (не влияет на геометрию)
    

**→ Запускает: paint → composite**

---

## Изменения, вызывающие только `composite`:

- `transform`
    
- `opacity`
    
- `filter`
    
- `will-change`
    
- `z-index` (иногда)
    

**→ Запускает: composite**

---

**Вывод:**

- `layout` → самый дорогой: триггерит всё ниже
    
- `paint` → средний
    
- `composite` → самый дешёвый
    

Минимизируй `layout`, избегай каскадных изменений DOM и читай layout-свойства осторожно.